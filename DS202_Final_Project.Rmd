---
title: "Proposal Draft 1"
authors: ["Abhay", "Srika","Neha","Esha","Niharika"]
date: "2023-11-12"
output: html_document
editor_options: 
  markdown: 
    wrap: sentence
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

### \*\*Project Title: Income and employment for the various county's in USA\*

```{r}
#census_api_key(Sys.getenv("CENSUS_API_KEY"), install = TRUE)
```

```{r}
#install.packages("tidycensus")
# Load necessary libraries
library(tidycensus)
library(dplyr)
library(tidyr)

#install.packages("factoextra")
library(factoextra)

#install.packages("ggplot2")
#install.packages("usmap")
#install.packages("maps")
library(ggplot2)
library(usmap)
library(maps)
```

## DF1 - EMPLOYMENT

```{r}
#Abhay
#Employment - K202301 for 2021

# Get ACS data
df1 <- get_acs(geography = "state", 
               table = "K202301", 
               year = 2021, 
               survey = "acs1-year", 
               cache_table = TRUE)

variables_df1 <- data.frame(
  variable = c("K202301_001", "K202301_002", "K202301_003", "K202301_004", "K202301_005", "K202301_006", "K202301_007"),
  label = c("Total", "In labor force: Civilian labor force: Employed", 
            "In labor force: Civilian labor force: Unemployed", "In labor force: Armed Forces", 
            "Not in labor force", "Other Category 1", "Other Category 2")
)
# Join with variable labels


# Now df_labeled will have an additional column with the variable labels
# Load variables for ACS 2022
# Sample mapping of variable codes to labels
# Replace this with the actual codes and labels


# Assuming df1 is your data frame with the estimates you've loaded
# Make sure to replace 'NAME' and 'estimate' with the actual column names from your df1

# Join your data with the variable labels to get the descriptive names
df1_labeled <- df1 %>%
  left_join(variables_df1, by = "variable")

# Reshape the data so that state names are rows and variable labels are columns
df1_wide <- df1_labeled %>%
  pivot_wider(names_from = label, values_from = estimate, id_cols = NAME)


# df_wide now has states as columns and the descriptive variable labels as rows


```

```{r}
# Calculate employment rates
df1_wide <- df1_wide %>%
  mutate(
    EmploymentRate = `In labor force: Civilian labor force: Employed` / `Total` * 100,
    UnemploymentRate = `In labor force: Civilian labor force: Unemployed` / `Total` * 100,
    NotInLaborForceRate = `Not in labor force` / `Total` * 100
  )

# Plotting employment rates
library(ggplot2)

ggplot(df1_wide, aes(x = reorder(NAME, -EmploymentRate), y = EmploymentRate)) +
  geom_bar(stat = "identity", fill = "steelblue") +
  labs(x = "State", y = "Employment Rate (%)", title = "Employment Rates by State") +
  theme_minimal() +
  theme(axis.text.x = element_text(angle = 90, vjust = 0.5, hjust=1))

```

```{r}
# Plotting labor force participation
ggplot(df1_wide, aes(x = NAME)) +
  geom_bar(aes(y = `In labor force: Civilian labor force: Employed`, fill = "Employed"), stat = "identity") +
  geom_bar(aes(y = `In labor force: Civilian labor force: Unemployed`, fill = "Unemployed"), stat = "identity") +
  geom_bar(aes(y = `In labor force: Armed Forces`, fill = "Armed Forces"), stat = "identity") +
  scale_fill_manual(values = c("Employed" = "green", "Unemployed" = "red", "Armed Forces" = "blue")) +
  theme(axis.text.x = element_text(angle = 90)) +
  labs(x = "State", y = "Number of People", fill = "Category", title = "Labor Force Participation by State")

```

```{r}
ggplot(df1_wide, aes(x = UnemploymentRate)) +
  geom_histogram(binwidth = 1, fill = "tomato", color = "black") +
  labs(x = "Unemployment Rate (%)", y = "Number of States", title = "Distribution of Unemployment Rates across States")

```

```{r}
# Correlation analysis
employment_data <- df1_wide %>%
  select(`In labor force: Civilian labor force: Employed`, `In labor force: Civilian labor force: Unemployed`, `In labor force: Armed Forces`, `Not in labor force`)

correlation_matrix <- cor(employment_data, use = "complete.obs")

# Visualize the correlation matrix
library(corrplot)
corrplot(correlation_matrix, method = "circle")

```

```{r}
# Calculate employment rate
# Assuming df1_wide or df6_wide has a column 'state' with state names or abbreviations
# Calculate the metric you want to plot (for example, Employment Rate)


# Assuming df1_wide has full state names in the 'NAME' column
# Convert state names to abbreviations
state_abbreviations <- state.abb[match(df1_wide$NAME, state.name)]
df1_wide$state <- state_abbreviations

# Ensure you have calculated the metric you want to plot (e.g., Employment Rate)
df1_wide$EmploymentRate <- df1_wide$`In labor force: Civilian labor force: Employed` / df1_wide$Total * 100

# Plot the map with employment rate
plot_usmap(data = df1_wide, values = "EmploymentRate", labels = TRUE) +
  scale_fill_continuous(name = "Employment Rate (%)", label = scales::percent_format()) +
  theme(legend.position = "right") +
  labs(title = "Employment Rate by State in 2021")


```

------------------------------------------------------------------------

------------------------------------------------------------------------

## DF6 - Disabilities

```{r}
#Abhay
#Disabilities - K201803
# Get ACS data for the Disabilities dataset
df6 <- get_acs(geography = "state", 
               table = "K201803", 
               year = 2021, 
               survey = "acs1-year", 
               cache_table = TRUE)

# Assuming the variables_df6 mapping is similar to variables_df1 but for the Disabilities table
# You need to create variables_df6 with the correct variable codes and labels for the Disabilities data
variables_df6 <- data.frame(
  variable = c("K201803_001", "K201803_002", "K201803_003", "K201803_004", "K201803_005", "K201803_006", "K201803_007","K201803_008","K201803_009"),
  label = c("Total people", "Total With Disabilities", 
            "Hearing", "Vision difficulty", 
            "cognative", "ambulatory difficulty", 
            "Self-care difficulty","Independent living difficulty","No Disability")
)

# Join your data with the variable labels to get the descriptive names
df6_labeled <- df6 %>%
  left_join(variables_df6, by = "variable")

# Reshape the data so that state names are rows and variable labels are columns
df6_wide <- df6_labeled %>%
  pivot_wider(names_from = label, values_from = estimate, id_cols = NAME)
df6_wide

# df6_wide now has states as rows and the descriptive variable labels as columns

```

```{r}
# Calculate percentages
df6_wide <- df6_wide %>%
  mutate(DisabilityRate = `Total With Disabilities` / `Total people` * 100)

# Plotting with ggplot2
library(ggplot2)

ggplot(df6_wide, aes(x = reorder(NAME, -DisabilityRate), y = DisabilityRate)) +
  geom_bar(stat = "identity", fill = "steelblue") +
  labs(x = "State", y = "Disability Rate (%)", title = "Disability Rates by State") +
  theme_minimal() +
  theme(axis.text.x = element_text(angle = 90, vjust = 0.5, hjust=1))

```

```{r}
# Select only the disability-related columns for correlation
disability_data <- df6_wide %>%
  select(`Hearing`, `Vision difficulty`, `cognative`, `ambulatory difficulty`, `Self-care difficulty`, `Independent living difficulty`)

# Compute correlation matrix
correlation_matrix <- cor(disability_data, use = "complete.obs")  # use = "complete.obs" handles missing values

# Check if corrplot is installed; if not, install it
if (!require(corrplot)) install.packages("corrplot")

library(corrplot)
corrplot(correlation_matrix, method = "circle")


```

```{r}
# Comparative analysis of disabilities within a state (example: Iowa)
iowa_data <- df6_wide %>%
  filter(NAME == "Iowa") %>%
 select(`Hearing`, `Vision difficulty`, `cognative`, `ambulatory difficulty`, `Self-care difficulty`, `Independent living difficulty`)

# Plotting the data for Iowa
barplot(as.matrix(iowa_data), beside = TRUE, legend.text = TRUE, args.legend = list(x = "topright"))

```

```{r}
# Predicting 'Ambulatory difficulty' based on other disabilities
lm_model <- lm(`ambulatory difficulty` ~ `Hearing` + `Vision difficulty` + `cognative` + `Self-care difficulty` + `Independent living difficulty`, data = df6_wide)

# Summary of the linear model
summary(lm_model)
lm_model
```

```{r}
# K-means clustering
#Perform a clustering analysis to identify groups of states with similar disability profiles.


# K-means clustering with 3 centers
set.seed(123)  # For reproducibility
clusters <- kmeans(disability_data, centers = 3)

# Add cluster assignment to the data
df6_wide$Cluster <- as.factor(clusters$cluster)

pca_res <- prcomp(disability_data, scale. = TRUE)
fviz_pca_biplot(pca_res, label = "none", col.ind = df6_wide$Cluster, addEllipses = TRUE)

```

------------------------------------------------------------------------

------------------------------------------------------------------------

## DF 2 - Education

```{r}
#Neha
#Education - K201501
df2 <- get_acs(geography = "state", 
                table = "K201501", 
                year = 2021, 
                survey = "acs1/subject",cache_table = TRUE)

variables_df2 <- data.frame(
  variable = c("K201501_001", "K201501_002", "K201501_003", "K201501_004", "K201501_005", "K201501_006", "K201501_007", "K201501_008"),
  label = c("Total", "Less than 9th grade", "9th to 12th grade,no diploma", "High school graduate", "Some college,no degree", "Associate's degree", "Bachelor's degree", "Graduate or professional degree")
)

df2_labeled <- df2 %>%
  left_join(variables_df2, by = "variable")

df2_wide <- df2_labeled %>%
  pivot_wider(names_from = label, values_from = estimate, id_cols = NAME)
```

------------------------------------------------------------------------

------------------------------------------------------------------------

## DF3 - Citizenship

```{r}
#Esha
#Citizenship - K200501

df3<- get_acs(
  geography = "state", 
  table = "K200501", 
  year = 2021, 
  survey = "acs1/subject", 
  cache_table = TRUE
)

variables_df3 <- data.frame(
  variable = c("K200501_001", "K200501_002"),  
  label = c("U.S. citizen", "Not a U.S. citizen")  
)

df3_labeled <- df3 %>%
  left_join(variables_df3, by = "variable")

df3_wide <- df3_labeled %>%
  pivot_wider(names_from = label, values_from = estimate, id_cols = NAME)


```

------------------------------------------------------------------------

\*\*\*

------------------------------------------------------------------------

## DF4 - Age

```{r}
#Srika
#Age - K200104
df4 <- get_acs(geography = "state", 
                table = "K200104", 
                year = 2021,
                survey = "acs1/subject",cache_table = TRUE
)
variables_df4 <- data.frame(
  variable = c("K200104_001", "K200104_002", "K200104_003", "K200104_004", "K200104_005", "K200104_006", "K200104_007", "K200104_008"),
  label = c("Total", "Under_18", 
            "18_to_24", "25_to_34", 
            "35_to_44", "45_to_54", "55_to_64","Over_64")
)

df4_labeled <- df4 %>%
  left_join(variables_df4, by = "variable")

df4_wide <- df4_labeled %>%
  pivot_wider(names_from = label, values_from = estimate, id_cols = NAME)

```

```{r}
library(tidyverse)
library(tigris)
Age_data <- get_acs(geography = "state", 
                table = "K200104", 
                year = 2021, 
               geometry = TRUE,
               resolution = "20m",
                survey = "acs1/subject",cache_table = TRUE
)
Mapping_age<-Age_data%>%
  filter(variable=="K200104_007")%>%
  shift_geometry()
ggplot(data = Mapping_age, aes(fill = estimate)) + 
  geom_sf()+
  scale_fill_distiller(palette = "RdPu", 
                       direction = 1) + 
  labs(title = "Median Age by State, 2021",
       caption = "Data source: 2021 1-year ACS, US Census Bureau",
       fill = "ACS estimate") + 
  theme_void()
```

------------------------------------------------------------------------

------------------------------------------------------------------------

## DF5 - Housing

```{r}
#Niharika
# Housing - K202502
housing_data <- get_acs(geography = "state", 
                        table = "K202502", 
                        year = 2021, 
                        survey = "acs1", 
                        cache_table = TRUE)

# Define the variable codes and their respective labels for the housing dataset (housing_data)
housing_variables <- data.frame(
  variable = c("K202502_001", "K202502_002", "K202502_003"),
  label = c("Total Housing Units", "Owner-Occupied Units", "Renter-Occupied Units")
)

# Assuming housing_data is your housing dataset
# Reshape the data so that state names are rows
housing_data_labeled <- housing_data %>%
  left_join(housing_variables, by = "variable")  # Joining with the variable labels dataframe

# Reshape the data to have state names as rows and variable labels as columns
housing_data_wide <- housing_data_labeled %>%
  pivot_wider(names_from = label, values_from = estimate, id_cols = NAME)

# housing_data_wide will have states as rows and different housing-related variables as columns



```

# Plan for Data Exploration

-   What we have done so far:
    -   Pulled the required ACS 2021 1 year data using a API call
    -   Cleaned the data
    -   Transformed to long format and formatted the table by focusing on the estimates we will be using.
-   We took the ACS 1 year data for the variables:
    -   EMPLOYMENT
    -   Education
    -   Citizenship
    -   Housing
    -   Age
    -   Disabilities
-   We are trying to see the relationship for the various with the employment fo reach state in the US.
-   We are planning to make some visualization like the above drafts which could inform the audience about the factors affecting the employment in various states in the US.

```{r}
merged_data <- df1_wide %>%
  left_join(df2_wide, by = "NAME") %>%
  left_join(df3_wide, by = "NAME")%>%
  left_join(df4_wide, by = "NAME")%>%
  left_join(df5_wide, by = "NAME")%>%
  left_join(df6_wide, by = "NAME")
```
